<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Lock IN</title>
<style>
:root {
  --bg: #111827; --card: #1f2937; --muted: #94a3b8; --accent: #22c55e;
  --glass: rgba(255, 255, 255, .05); --border: rgba(255, 255, 255, .1);
  --error: #ef4444;
}

html, body {
  height: 100%; margin: 0; font-family: Inter, system-ui, sans-serif;
  color: #f8fafc; background: var(--bg); overscroll-behavior-y: none;
}

body { 
  display: flex; justify-content: center; align-items: flex-start; 
  padding: 16px; box-sizing: border-box;
}

.app {
  max-width: 600px; width: 100%; margin: 10px auto; padding: 24px;
  border-radius: 16px; background: var(--card);
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  box-sizing: border-box; display: flex; flex-direction: column;
}

.screen { display: none; }
.screen.active { display: block; }
.screen-focus.active { display: flex; }

.focus-shell {
  width: 100%;
  min-height: 72vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  gap: 28px;
}

.focus-stack {
  width: 100%;
  max-width: 520px;
  min-height: 300px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 12px;
}

.focus-item {
  text-align: center;
  transition: transform 450ms ease, opacity 450ms ease;
}

.focus-item-prev {
  opacity: 0.38;
  transform: translateY(-8px) scale(0.96);
  font-size: 18px;
  font-weight: 500;
}

.focus-item-next {
  opacity: 0.38;
  transform: translateY(8px) scale(0.96);
  font-size: 18px;
  font-weight: 500;
}

.focus-item-current {
  opacity: 1;
  transform: scale(1.03);
}

.focus-current-task {
  font-size: 34px;
  font-weight: 800;
  line-height: 1.1;
}

.focus-current-timer {
  margin-top: 8px;
  font-size: 40px;
  font-weight: 800;
  font-variant-numeric: tabular-nums;
}

.focus-item-completing {
  opacity: 0.18;
  transform: translateY(42px) scale(0.95);
}

.focus-actions {
  width: 100%;
  max-width: 380px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.focus-lock-switch {
  width: 100%;
  cursor: pointer;
}

.focus-lock-switch input {
  position: absolute;
  opacity: 0;
  pointer-events: none;
}

.focus-lock-track {
  width: 100%;
  height: 64px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: #111827;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: relative;
  padding: 0 18px;
  box-sizing: border-box;
}

.focus-lock-knob {
  position: absolute;
  top: 6px;
  left: 6px;
  width: 52px;
  height: 52px;
  border-radius: 999px;
  background: #f8fafc;
  transition: transform 450ms ease;
}

.focus-lock-label-on,
.focus-lock-label-off {
  position: relative;
  z-index: 1;
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 0.06em;
}

.focus-lock-label-on { color: #111827; }
.focus-lock-label-off { color: var(--muted); }

.focus-lock-switch input:checked + .focus-lock-track {
  background: var(--accent);
}

.focus-lock-switch input:checked + .focus-lock-track .focus-lock-knob {
  transform: translateX(calc(100% - 12px));
}

.focus-complete-wrap {
  width: 100%;
  transition: transform 450ms ease, opacity 450ms ease;
}

.focus-complete-wrap.focus-complete-firing {
  transform: translateY(6px) scale(0.98);
  opacity: 0.75;
}

.focus-complete-btn {
  width: 100%;
  padding: 16px;
}

.focus-manage-btn {
  width: 100%;
}

header { display: flex; flex-direction: column; margin-bottom: 24px; }
h1 { margin: 0; font-size: 24px; color: var(--accent); }
.subtitle { font-size: 13px; color: var(--muted); margin-top: 4px; }

button {
  font-size: 16px; padding: 12px; border-radius: 10px;
  border: 1px solid var(--border); background: #111827; color: inherit;
  touch-action: manipulation; cursor: pointer;
  transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), background-color 0.2s;
  outline: none;
}
button:active { transform: scale(1.08); filter: brightness(1.2); }
input {
  font-size: 16px; padding: 12px; border-radius: 10px;
  border: 1px solid var(--border); background: #111827; color: inherit;
  width: 100%; box-sizing: border-box;
}

.main-add-container { margin-bottom: 24px; }
.btn-add-task { width: 100%; background: var(--accent); color: #000; font-weight: 700; border: none; }

.task-list { display: grid; gap: 12px; margin-bottom: 12px; }
.task {
  padding: 16px; border-radius: 12px; border: 1px solid var(--border);
  background: #111827; display: flex; justify-content: space-between;
  align-items: center; gap: 12px; transition: all 0.2s ease; overflow: hidden;
  cursor: grab; user-select: none;
}

.task-content { flex: 1; min-width: 0; overflow-wrap: break-word; }
.task.selected { border: 2px solid var(--accent); box-shadow: 0 0 10px rgba(34, 197, 94, 0.2); }
.task.done { background: #1f2937; border-color: #374151; color: #64748b; text-decoration: line-through; opacity: 0.7; }

.timer-grid { display: none; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px; margin-bottom: 10px; }
.timer-card { background: var(--glass); padding: 15px; border-radius: 14px; border: 1px solid var(--border); text-align: center; }
.time { font-size: 28px; font-weight: 700; font-variant-numeric: tabular-nums; }

.actions { display: none; gap: 12px; margin-top: 20px; margin-bottom: 24px;}
.actions button { flex: 1; padding: 16px; font-size: 18px; }
button.primary { background: var(--accent); border: none; color: #000; font-weight: 700; }

.overlay {
  position: fixed; inset: 0; background: rgba(0, 0, 0, 0.9);
  display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px;
  backdrop-filter: blur(4px);
}
.overlay-card { background: var(--card); padding: 24px; border-radius: 16px; width: 100%; max-width: 440px; text-align: center; box-sizing: border-box; }

.hero-title { font-size: 48px; font-weight: 900; letter-spacing: -3px; color: #fff; font-style: italic; margin-bottom: 10px; }

.insights-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 20px 0; }
.insight-item { background: #111827; padding: 16px; border-radius: 12px; border: 1px solid var(--border); text-align: left; position: relative; }
.insight-label { font-size: 10px; color: var(--muted); text-transform: uppercase; font-weight: 700; display: flex; align-items: center; gap: 6px; }
.insight-val { font-size: 22px; font-weight: 800; margin-top: 6px; color: #fff; }

.info-wrapper { position: relative; display: inline-flex; align-items: center; }
.info-icon { 
  cursor: pointer; color: var(--accent); font-size: 10px; 
  background: rgba(34, 197, 94, 0.1); width: 14px; height: 14px; 
  display: flex; align-items: center; justify-content: center; 
  border-radius: 50%; border: 1px solid rgba(34, 197, 94, 0.3);
  font-weight: bold;
}

/* Bottom Sheet */
.bottom-sheet {
  position: fixed; bottom: -100%; left: 0; right: 0;
  background: var(--card); border-top: 1px solid var(--border);
  border-radius: 20px 20px 0 0; padding: 24px; z-index: 2000;
  transition: bottom 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
}
.bottom-sheet.active { bottom: 0; }
.sheet-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.6);
  display: none; z-index: 1999; backdrop-filter: blur(2px);
}
.sheet-overlay.active { display: block; }
.handle { width: 40px; height: 4px; background: #374151; border-radius: 2px; margin: -12px auto 20px auto; }

/* Modal New UI Components */
.setting-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; text-align: left; }
.setting-label { font-size: 12px; font-weight: 700; color: var(--muted); text-transform: uppercase; }

.toggle-switch {
  position: relative; display: inline-block; width: 50px; height: 26px;
}
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.slider {
  position: absolute; cursor: pointer; inset: 0; background-color: #374151;
  transition: .4s; border-radius: 34px;
}
.slider:before {
  position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px;
  background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--accent); }
input:checked + .slider:before { transform: translateX(24px); }

.range-picker { width: 100%; margin: 8px 0; accent-color: var(--accent); }

.task-breakdown { text-align: left; max-height: 180px; overflow-y: auto; margin-top: 20px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; }
.breakdown-row { display: flex; justify-content: space-between; font-size: 13px; padding: 10px 0; border-bottom: 1px solid var(--border); }

footer { margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border); text-align: center; font-size: 11px; color: var(--muted); }

.smart-picker { margin: 10px 0 20px 0; }
.smart-picker input {
  width: 100%; height: 56px; text-align: center; font-size: 28px; 
  font-family: monospace; letter-spacing: 2px;
  border: 2px solid var(--accent); background: #111827; color: var(--accent);
  border-radius: 12px;
}


#resBreakdown td, #resBreakdown th {
  padding: 8px;
  border-bottom: 1px solid var(--border);
}

#resBreakdown tr:hover {
  background: rgba(255,255,255,0.05);
}

#pulsePopup {
  backdrop-filter: blur(8px);
}

#pulseTapCard {
  width: min(90vw, 420px);
  height: 200px;

  border-radius: 28px; /* squarish-round */
  display: flex;
  align-items: center;
  justify-content: center;

  font-size: 34px;
  font-weight: 900;
  letter-spacing: 1px;

  color: #000;
  cursor: pointer;
  user-select: none;

  transition:
    background-color 0.8s ease,
    box-shadow 0.8s ease,
    transform 0.2s ease;

  box-shadow:
    0 20px 60px rgba(0,0,0,0.6);
}

/* Pulse beat stays subtle */
#pulseTapCard:active {
  transform: scale(1.05);
}

/* COLOR STATES */
.pulse-green {
  background: #22c55e;
  box-shadow: 0 0 60px rgba(34,197,94,0.6);
}

.pulse-yellow {
  background: #eab308;
  box-shadow: 0 0 60px rgba(234,179,8,0.6);
}

.pulse-orange {
  background: #f97316;
  box-shadow: 0 0 60px rgba(249,115,22,0.6);
}

.pulse-red {
  background: #ef4444;
  box-shadow: 0 0 60px rgba(239,68,68,0.6);
}


@keyframes pulseBeat {
  0%   { transform: scale(1); }
  50%  { transform: scale(1.08); }
  100% { transform: scale(1); }
}

.app.blurred {
  filter: blur(6px);
  pointer-events: none;
}


</style>
</head>
<body>

<div id="welcomeScreen" class="overlay" style="display: flex;">
  <div class="overlay-card">
    <div class="hero-title">LOCK-IN</div>
    <p class="subtitle" style="font-size: 14px; margin-bottom: 30px; line-height: 1.6;">High-integrity performance auditor.<br>Observation mode active.</p>
    <button onclick="closeWelcome()" class="primary" style="width: 100%; padding: 18px;">Continue</button>
  </div>
</div>

<div class="app" id="app">
  <section id="focusScreen" class="screen screen-focus">
    <div class="focus-shell">
      <div id="focusStack" class="focus-stack"></div>
      <div class="focus-actions" id="focusActions">
        <label class="focus-lock-switch">
          <input type="checkbox" id="focusLockToggle">
          <span class="focus-lock-track">
            <span class="focus-lock-knob"></span>
            <span class="focus-lock-label-on">LOCK</span>
            <span class="focus-lock-label-off">UNLOCK</span>
          </span>
        </label>
        <div id="focusCompleteWrap" class="focus-complete-wrap">
          <button id="focusCompleteBtn" class="primary focus-complete-btn">Complete Task</button>
        </div>
        <div id="focusManageSlot"></div>
      </div>
    </div>
  </section>

  <section id="manageScreen" class="screen screen-manage active">
    <header>
      <h1>ðŸ”’ Lock-In Tool</h1>
      <div class="subtitle">v4.6 [Integrity Engine]</div>
    </header>

    <div class="main-add-container" id="addWrapper">
      <button class="btn-add-task" id="openAddModalBtn">+ Add New Task</button>
    </div>

    <div id="taskList" class="task-list"></div>

    <div id="timerGrid" class="timer-grid">
      <div class="timer-card">
        <div id="currentTaskDisplay" style="font-size: 12px; color: var(--muted); margin-bottom: 5px;">No task</div>
        <div class="time" id="countdown">00:00:00</div>
      </div>
      <div class="timer-card">
        <div id="stateText" style="font-size: 12px; color: var(--muted); margin-bottom: 5px;">Idle</div>
        <div class="time" id="stopwatch">00:00:00</div>
      </div>
    </div>

    <div class="actions" id="actionButtons">
      <button id="startBtn" class="primary">Start</button>
      <button id="completeBtn">log task</button>
    </div>

    <button id="endSessionBtn" style="display:none; margin-top: 12px; border-color: var(--error); color: var(--error); width: 100%;">End Session Early</button>

    <footer>by sajo moanne</footer>
  </section>
</div>

<!-- Task Modal -->
<div id="taskEditorOverlay" class="overlay">
  <div class="overlay-card">
    <h3 id="modalTitle" style="margin-top:0; margin-bottom:16px;">Task Details</h3>
    <input id="modalTaskName" type="text" placeholder="task name">
    
    <div class="smart-picker">
      <div class="setting-label" style="margin-bottom: 8px;">Estimate (HH:MM:SS)</div>
      <input id="smartTimeInput" type="text" value="00:00:00" maxlength="8">
    </div>

    <!-- Mode Switch -->
    <div class="setting-row" style="flex-direction:column; align-items:flex-start;">
      <div class="setting-label">Work Mode</div>
      <select id="workModeSelect" style="width:100%; padding:12px; border-radius:10px; background:#111827; color:#fff; border:1px solid var(--border);">
        <option value="">Blank</option>
        <option value="ONLINE">Online</option>
        <option value="OFFLINE">Offline</option>
      </select>
    </div>

    <!-- Pulse Slider -->
    <div class="setting-row" style="flex-direction: column; align-items: flex-start;">
      <div class="setting-label">Pulse Frequency: <span id="pulseDisplay" style="color:var(--accent)">15m</span></div>
      <input type="range" id="pulseRange" class="range-picker" min="0" max="30" step="5" value="15">
      <div style="width:100%; display:flex; justify-content:space-between; font-size:10px; color:var(--muted)">
        <span>OFF</span><span>15m</span><span>30m</span>
      </div>
    </div>

    <div style="display:flex; flex-direction: column; gap: 10px; margin-top: 20px;">
      <div style="display:flex; gap:10px;">
        <button id="cancelEditor" style="flex:1; background:#374151; border:none;">Cancel</button>
        <button id="saveTaskBtn" style="flex:1; background:var(--accent); color:#000; border:none; font-weight: 700;">Confirm</button>
      </div>
      <button id="deleteTaskBtn" style="background:transparent; color:var(--error); border:1px solid var(--error); font-size: 14px; display: none;">Delete Task</button>
    </div>
  </div>
</div>

<!-- Bottom Sheet -->
<div id="sheetOverlay" class="sheet-overlay" onclick="toggleSheet()"></div>
<div id="bottomSheet" class="bottom-sheet">
  <div class="handle"></div>
  <h4 id="sheetTitle" style="margin: 0 0 10px 0; color: var(--accent);">Formula Explanation</h4>
  <p id="sheetBody" style="font-size: 14px; color: var(--muted); line-height: 1.6; margin: 0;"></p>
  <button onclick="toggleSheet()" style="width: 100%; margin-top: 20px; background: var(--card); border: 1px solid var(--border);">Close</button>
</div>

<!-- Confirm End -->
<div id="confirmEndOverlay" class="overlay">
  <div class="overlay-card">
    <h3 style="margin-top:0">End Session?</h3>
    <p class="subtitle" style="margin-bottom: 24px;">This will stop all timers and calculate final insights.</p>
    <div style="display:flex; gap:10px;">
      <button onclick="closeConfirm()" style="flex:1; background:#374151; border:none;">Cancel</button>
      <button id="confirmEndBtn" style="flex:1; background:var(--error); color:#fff; border:none; font-weight: 700;">Yes, End Session</button>
    </div>
  </div>
</div>

<!-- Results -->
<div id="resultsOverlay" class="overlay">
  <div class="overlay-card" style="max-width: 500px;">
    <h3 style="margin:0; color:var(--accent)">Session Insights</h3>
    <div class="insights-grid">
      <div class="insight-item">
        <div class="insight-label">Session Duration</div>
        <div class="insight-val" id="resTotal">00:00:00</div>
      </div>
      <div class="insight-item">
        <div class="insight-label">Work Time</div>
        <div class="insight-val" id="resFocused">00:00:00</div>
      </div>
      <div class="insight-item">
        <div class="insight-label">Sidelined Time <span class="info-icon" onclick="openSheet('sidelined')">i</span></div>
        <div class="insight-val" id="resPaused">00:00:00</div>
      </div>
      <div class="insight-item">
        <div class="insight-label">Focus Ratio <span class="info-icon" onclick="openSheet('focus')">i</span></div>
        <div class="insight-val" id="resRatio">0%</div>
      </div>
    </div>

    <table id="resBreakdown" style="width:100%; border-collapse:collapse; font-size:13px;">
      <thead>
        <tr style="color:var(--muted); text-align:left;">
          <th>Task</th>
          <th>Mode</th>
          <th>Paused</th>
          <th>Work</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button id="closeStatsBtn" class="primary" style="width:100%; margin-top:20px">New Session</button>
  </div>
</div>

<div id="taskTimelineOverlay" class="overlay">
  <div class="overlay-card" style="max-width:500px;">
    <h3>Task Timeline</h3>
    <table id="taskTimelineTable" style="width:100%; font-size:13px;">
      <thead>
        <tr>
          <th>Event</th>
          <th>Time</th>
          <th>Valid</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button id="confirmTaskTimelineBtn" class="primary" style="width:100%; margin-top:15px;">Confirm</button>
  </div>
</div>

<!-- Pulse Popup -->
<div id="pulsePopup" class="overlay">
  <div id="pulseTapCard" class="overlay-card" style="
    padding: 40px;
    font-size: 28px;
    font-weight: 900;
    text-align: center;
    cursor: pointer;
    user-select: none;
  ">
    YOU THERE?
  </div>
</div>

<script>
let tasks = [], current = null, paused = true, tick = null;
let sessionStartTimestamp = null, sessionEndTimestamp = null;
let totalFocusedSeconds = 0, editingIndex = null;

// ==== PULSE SYSTEM STATE (ADDITIVE) ====
let pulseTimer = null;
let pulseLog = [];
let lastPulseAt = null;
let activePulse = null;

let pendingSessionEnd = false;

let lastTickAt = null;
let uiScreen = 'manage';
let completionInFlight = false;
const FOCUS_COMPLETE_ANIM_MS = 450;

const $ = id => document.getElementById(id);

function setScreen(mode) {
  const focus = $('focusScreen');
  const manage = $('manageScreen');
  if (!focus || !manage) return;
  const target = paused === false ? 'focus' : mode;
  uiScreen = target === 'focus' ? 'focus' : 'manage';
  focus.classList.remove('active');
  manage.classList.remove('active');
  if (uiScreen === 'focus') {
    focus.classList.add('active');
  } else {
    manage.classList.add('active');
  }
}

function syncScreenRoute() {
  if (paused === false) {
    setScreen('focus');
    return;
  }
  if (!sessionStartTimestamp) {
    setScreen('manage');
    return;
  }
  setScreen(uiScreen);
}

function isOverlayVisible(id) {
  const el = $(id);
  return !!el && el.style.display === 'flex';
}

function clearPulseForTransition() {
  if (pulseTimer) { clearInterval(pulseTimer); pulseTimer = null; }
  if (activePulse) {
    if (activePulse.timeout) { clearTimeout(activePulse.timeout); activePulse.timeout = null; }
    if (activePulse.colorTimer) { clearInterval(activePulse.colorTimer); activePulse.colorTimer = null; }
  }
  activePulse = null;
  $('pulsePopup').style.display = 'none';
  $('app')?.classList.remove('blurred');
}

const fmt = (s) => {
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  const sec = s % 60;
  return `${h > 0 ? String(h).padStart(2, '0') + ':' : ''}${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
};

// Modal UI Logic

$('pulseRange').oninput = (e) => {
  const v = parseInt(e.target.value);
  $('pulseDisplay').textContent = v === 0 ? 'OFF' : v + 'm';
};

// Smart Input
const timeInput = $('smartTimeInput');
timeInput.addEventListener('keydown', (e) => {
    if (e.key === 'Backspace') {
        e.preventDefault();
        let val = timeInput.value.replace(/\D/g, '').slice(0, -1).padStart(6, '0');
        updateTimeDisplay(val);
    } else if (/^\d$/.test(e.key)) {
        e.preventDefault();
        let val = (timeInput.value.replace(/\D/g, '') + e.key).slice(-6);
        updateTimeDisplay(val);
    } else if (e.key !== 'Tab') { e.preventDefault(); }
});

function updateTimeDisplay(digits) {
    const h = digits.slice(0, 2), m = digits.slice(2, 4), s = digits.slice(4, 6);
    timeInput.value = `${h}:${m}:${s}`;
}

function timeToSeconds(str) {
  const p = str.split(':').map(x => parseInt(x) || 0);
  return (p[0] * 3600) + (p[1] * 60) + p[2];
}

function toggleSheet() {
  $('bottomSheet').classList.toggle('active');
  $('sheetOverlay').classList.toggle('active');
}

/// OPEN SHEET FUNCTION ///

function openSheet(type) {
  const title = $('sheetTitle'), body = $('sheetBody');
  if (type === 'focus') {
    title.textContent = "Focus Ratio";
    body.innerHTML = "Formula: <strong style='color:#fff'>focused time / total time</strong><br><br>Total time includes all pauses and gaps.";
  } else if (type === 'sidelined') {
    title.textContent = "Sidelined Time";
    body.innerHTML = "Tracks time where the session was running, but you were not working on a task (e.g., pauses or switching).";
  }
  toggleSheet();
}

/// CLOSE WELCOME FUNCTION ///

function closeWelcome() {
  $('welcomeScreen').style.display = 'none'; 
  if ("Notification" in window && Notification.permission === "default") {
    Notification.requestPermission();
  }
}

function closeConfirm() { $('confirmEndOverlay').style.display = 'none'; }


$('endSessionBtn').onclick = () => {
  if (activePulse && !activePulse.answered) return;
  $('confirmEndOverlay').style.display = 'flex';
};
$('confirmEndBtn').onclick = () => { closeConfirm(); endSession(); };

$('focusLockToggle').onchange = (e) => {
  const wantsLocked = e.target.checked;
  if (wantsLocked && paused) {
    $('startBtn').onclick();
    return;
  }
  if (!wantsLocked && !paused) {
    $('startBtn').onclick();
    return;
  }
  render();
};

$('focusCompleteBtn').onclick = () => {
  completeTaskWithFocusAnimation();
};


/// FIRE PULSE FUNCTION ///

function firePulse(task) {
  const now = Date.now();

  if (paused) return;
  if (isOverlayVisible('confirmEndOverlay') || isOverlayVisible('taskTimelineOverlay') || isOverlayVisible('resultsOverlay')) return;
  if (activePulse && !activePulse.answered) {
    return; // don't stack pulses
  }

  const taskIndex = tasks.indexOf(task);
  if (taskIndex === -1) return;

  const pulseEntry = {
    task: task.text,
    taskIndex,
    time: now,
    answered: false
    
  };
  activePulse = pulseEntry;


  pulseLog.push(pulseEntry);

  task.log.push({
    type: 'PULSE',
    time: now,
    answered: false
  });
  pulseEntry.logIndex = task.log.length - 1;

  // In-app pulse popup
  if (document.visibilityState === 'visible') {
    showPulsePopup(pulseEntry);
  } else if ("Notification" in window && Notification.permission === "granted") {
    new Notification("Lock-In Check", {
      body: "You there?",
      tag: "lockin-pulse",
      silent: true
    });
  }

  lastPulseAt = now;

  pulseEntry.timeout = setTimeout(() => {
  if (!pulseEntry.answered) {
    failPulse(pulseEntry);
    }
  }, 60 * 1000);

}

/// SHOW PULSE POPUP FUNCTION ///

function showPulsePopup(pulseEntry) {
  const popup = $('pulsePopup');
  const card = $('pulseTapCard');

  popup.style.display = 'flex';

  const pulseStart = pulseEntry.time;

  // initial color
  updatePulseColor(pulseStart);

  // update color every second
  pulseEntry.colorTimer = setInterval(() => {
    updatePulseColor(pulseStart);
  }, 1000);

  card.onclick = () => {
    clearInterval(pulseEntry.colorTimer);
    answerPulse(pulseEntry);
  };
}


/// PULSE COLOR FUNCTION ///

function updatePulseColor(startTime) {
  const elapsed = Math.floor((Date.now() - startTime) / 1000);
  const card = $('pulseTapCard');

  card.className = ''; // reset

  if (elapsed < 10) {
    card.classList.add('pulse-green');
  } else if (elapsed < 30) {
    card.classList.add('pulse-yellow');
  } else if (elapsed < 45) {
    card.classList.add('pulse-orange');
  } else {
    card.classList.add('pulse-red');
  }
}


/// ANSWER PULSE FUNCTION ///

function answerPulse(pulseEntry) {
  pulseEntry.answered = true;
  if (pulseEntry.timeout) { clearTimeout(pulseEntry.timeout); pulseEntry.timeout = null; }
  if (pulseEntry.colorTimer) { clearInterval(pulseEntry.colorTimer); pulseEntry.colorTimer = null; }
  activePulse = null;

  const task = tasks[pulseEntry.taskIndex];
  if (task && task.log[pulseEntry.logIndex] && task.log[pulseEntry.logIndex].type === 'PULSE') {
    task.log[pulseEntry.logIndex].answered = true;
  }

  $('pulsePopup').style.display = 'none';
  $('app')?.classList.remove('blurred');
}

/// FAIL PULSE FUNCTION ///

function failPulse(pulseEntry) {
  if (pulseEntry.answered) return;
  pulseEntry.answered = false;
  if (pulseEntry.timeout) { clearTimeout(pulseEntry.timeout); pulseEntry.timeout = null; }
  if (pulseEntry.colorTimer) { clearInterval(pulseEntry.colorTimer); pulseEntry.colorTimer = null; }
  activePulse = null;

  const task = tasks[pulseEntry.taskIndex];
  if (!task) return;

  // mark pulse as failed in task log
  if (task.log[pulseEntry.logIndex] && task.log[pulseEntry.logIndex].type === 'PULSE') {
    task.log[pulseEntry.logIndex].failed = true;
  }

  // add 60s sidelined time
  task.pauses += 60;

  // close popup + unblur if visible
  $('pulsePopup').style.display = 'none';
  $('app')?.classList.remove('blurred');
}

function focusTimerText() {
  if (paused === true) return '00:00';
  if (current === null || !tasks[current]) return '00:00';
  return $('countdown').textContent || '00:00';
}

function renderFocusStack() {
  const stack = $('focusStack');
  stack.innerHTML = '';

  if (tasks.length === 0 || current === null || !tasks[current]) {
    const empty = document.createElement('div');
    empty.className = 'focus-item focus-item-current';
    empty.innerHTML = `
      <div class="focus-current-task">No Active Task</div>
      <div class="focus-current-timer">00:00</div>
    `;
    stack.appendChild(empty);
    return;
  }

  const startPrev = Math.max(0, current - 2);
  for (let i = startPrev; i < current; i++) {
    const row = document.createElement('div');
    row.className = 'focus-item focus-item-prev';
    row.textContent = tasks[i].text;
    stack.appendChild(row);
  }

  const currentRow = document.createElement('div');
  currentRow.className = 'focus-item focus-item-current';
  currentRow.dataset.taskIndex = String(current);
  currentRow.innerHTML = `
    <div class="focus-current-task">${tasks[current].text}</div>
    <div class="focus-current-timer">${focusTimerText()}</div>
  `;
  stack.appendChild(currentRow);

  const endNext = Math.min(tasks.length - 1, current + 2);
  for (let i = current + 1; i <= endNext; i++) {
    const row = document.createElement('div');
    row.className = 'focus-item focus-item-next';
    row.textContent = tasks[i].text;
    stack.appendChild(row);
  }
}

function renderFocusActions() {
  $('focusLockToggle').checked = paused === false;
  $('focusLockToggle').disabled = current === null;
  $('focusCompleteBtn').disabled = current === null || completionInFlight;

  const manageSlot = $('focusManageSlot');
  manageSlot.innerHTML = '';
  if (paused === true) {
    const manageBtn = document.createElement('button');
    manageBtn.id = 'focusManageBtn';
    manageBtn.className = 'focus-manage-btn';
    manageBtn.textContent = 'Manage';
    manageBtn.onclick = () => {
      if (paused === false) {
        setScreen('focus');
      } else {
        setScreen('manage');
      }
      render();
    };
    manageSlot.appendChild(manageBtn);
  }
}

function completeTaskFlow() {
  if (current === null) {
    completionInFlight = false;
    $('focusCompleteWrap')?.classList.remove('focus-complete-firing');
    return;
  }

  if (!paused) {paused = true;clearInterval(tick);}

  clearPulseForTransition();
  tasks[current].log.push({ type: 'END', time: Date.now() });
  const completedTaskIndex = current;
  tasks[current].done = true;

  clearInterval(pulseTimer);
  pulseTimer = null;

  if (tasks.every(t => t.done)) {
    pendingSessionEnd = true;
  }
  openTaskTimeline(completedTaskIndex);
}

function completeTaskWithFocusAnimation() {
  if (current === null) return;
  if (completionInFlight) return;
  completionInFlight = true;

  if (!paused) {
    paused = true;
    clearInterval(tick);
    $('stateText').textContent = 'Paused';
  }
  clearPulseForTransition();
  $('focusCompleteWrap')?.classList.add('focus-complete-firing');

  const shouldAnimate = $('focusScreen').classList.contains('active');
  if (!shouldAnimate) {
    completeTaskFlow();
    return;
  }

  const currentItem = $('focusStack').querySelector('.focus-item-current');
  if (!currentItem) {
    completeTaskFlow();
    return;
  }

  currentItem.classList.add('focus-item-completing');
  setTimeout(() => {
    completeTaskFlow();
  }, FOCUS_COMPLETE_ANIM_MS);
}


/// RENDER FUNCTION ///

function render() {
  syncScreenRoute();
  const list = $('taskList'); list.innerHTML = '';
  tasks.forEach((t, i) => {
    const d = document.createElement('div');
    d.className = 'task' + (i === current ? ' selected' : '') + (t.done ? ' done' : '');
    d.onclick = () => { if (!t.done && paused) { clearPulseForTransition(); current = i; render(); } };
    
    const spentDisplay = i === current && !paused ? fmt(t.spent + Math.floor((Date.now() - lastTickAt) / 1000)): fmt(t.spent);

    const content = document.createElement('div');
    content.className = 'task-content';
    content.innerHTML = `<b>${t.text}</b> <span style="font-size:9px; color:var(--muted); opacity:0.6">[${t.mode}]</span><br><small>${fmt(t.est)} est | ${spentDisplay} spent</small>`;
    d.appendChild(content);

    if (!t.done && paused) {
      const eb = document.createElement('button');
      eb.innerHTML = 'âœŽ'; eb.style.cssText = "background:transparent; border:none; font-size:18px;";
      eb.onclick = (e) => { e.stopPropagation(); openEdit(i); };
      d.appendChild(eb);
    }
    list.appendChild(d);
  });
  if (current !== null) {
    $('currentTaskDisplay').textContent = tasks[current].text;
    $('countdown').textContent = fmt(Math.max(0, tasks[current].est - tasks[current].spent));
    $('stopwatch').textContent = fmt(tasks[current].spent);
    $('startBtn').textContent = paused ? (tasks[current].spent > 0 ? 'Resume' : 'Start') : 'Pause';
  }
  $('addWrapper').style.display = (paused || current === null) ? 'block' : 'none';
  $('timerGrid').style.display = (current !== null) ? 'grid' : 'none';
  $('endSessionBtn').style.display = sessionStartTimestamp ? 'block' : 'none';
  $('actionButtons').style.display = (current !== null) ? 'flex' : 'none';
  renderFocusStack();
  renderFocusActions();
}

/// OPEN TASK TIMELINE FUNCTION ///

function openTaskTimeline(index) {
  if (activePulse && !activePulse.answered) {
    completionInFlight = false;
    $('focusCompleteWrap')?.classList.remove('focus-complete-firing');
    return;
  }
  const t = tasks[index];
  const tbody = $('taskTimelineTable').querySelector('tbody');
  tbody.innerHTML = '';

  t.log.forEach((e, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${e.type}</td>
      <td>${new Date(e.time).toLocaleTimeString()}</td>

      <td>${e.type === 'PULSE'? `<input type="checkbox" ${e.answered ? 'checked' : ''} onchange="this.checked ? (tasks[${index}].log[${i}].answered = true) : (tasks[${index}].log[${i}].answered = false)">`: 'â€”'}</td>
    `;

    tbody.appendChild(tr);
  });

  $('taskTimelineOverlay').style.display = 'flex';
  
  $('confirmTaskTimelineBtn').onclick = () => {
    $('taskTimelineOverlay').style.display = 'none';

    // Move to next task
    const next = tasks.findIndex(t => !t.done);
    current = next !== -1 ? next : null;
    completionInFlight = false;
    $('focusCompleteWrap')?.classList.remove('focus-complete-firing');

    render();

    // If all tasks done â†’ end session
    if (pendingSessionEnd) {
      pendingSessionEnd = false;
      endSession();
    }
  };
}

$('openAddModalBtn').onclick = () => {
  editingIndex = null;
  $('modalTitle').textContent = "Add New Task";
  $('modalTaskName').value = ""; 
  $('smartTimeInput').value = "00:00:00";
  $('pulseRange').value = 15;
  $('pulseDisplay').textContent = '15m';
  $('deleteTaskBtn').style.display = 'none';
  $('taskEditorOverlay').style.display = 'flex';
};

/// OPEN EDIT FUNCTION ///

function openEdit(index) {
  editingIndex = index;
  const t = tasks[index];
  $('modalTitle').textContent = "Edit Task";
  $('modalTaskName').value = t.text;
  const h = Math.floor(t.est/3600), m = Math.floor((t.est%3600)/60), s = t.est%60;
  $('smartTimeInput').value = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  $('workModeSelect').value = t.mode || '';
  $('pulseRange').value = t.pulse;
  $('pulseDisplay').textContent = t.pulse === 0 ? 'OFF' : t.pulse + 'm';
  $('deleteTaskBtn').style.display = 'block';
  $('taskEditorOverlay').style.display = 'flex';
}

/// DELETE TASK FUNCTION ///

$('deleteTaskBtn').onclick = () => {
  if (editingIndex !== null) {
    tasks.splice(editingIndex, 1);
    if (current === null && tasks.length) {
      current = tasks.findIndex(t => !t.done);
    }
    $('taskEditorOverlay').style.display = 'none';
    render();
  }
};

/// SAVE TASK FUNCTION ///

$('saveTaskBtn').onclick = () => {
  const name = $('modalTaskName').value.trim(), timeStr = $('smartTimeInput').value;
  if (!name || timeToSeconds(timeStr) <= 0) return;
  const mode = $('workModeSelect').value;
  const pulse = parseInt($('pulseRange').value);
  
  if (editingIndex === null) {
    tasks.push({ text: name, est: timeToSeconds(timeStr), spent: 0, done: false, log: [], pauses: 0,pauseStartedAt: null, mode, pulse });
  } else {
    tasks[editingIndex].text = name; 
    tasks[editingIndex].est = timeToSeconds(timeStr);
    tasks[editingIndex].mode = mode;
    tasks[editingIndex].pulse = pulse;
  }
  $('taskEditorOverlay').style.display = 'none'; 
  render();
};

$('cancelEditor').onclick = () => { $('taskEditorOverlay').style.display = 'none'; };

/// START BUTTON FUNCTION ///

$('startBtn').onclick = () => {
  if (current === null) return;
  if (paused) {
    paused = false;
    $('stateText').textContent = 'Running';
    if (!sessionStartTimestamp) sessionStartTimestamp = Date.now();

    if (!tasks[current].log.length) {
      tasks[current].log.push({ type: 'START', time: Date.now() });
    } else {
      tasks[current].log.push({ type: 'RESUME', time: Date.now() });
    }
    lastTickAt = Date.now();
    tick = setInterval(() => {
      tasks[current].spent++;
      totalFocusedSeconds++;
      $('countdown').textContent = fmt(Math.max(0, tasks[current].est - tasks[current].spent));
      $('stopwatch').textContent = fmt(tasks[current].spent);
      const focusTimer = $('focusStack').querySelector('.focus-current-timer');
      if (focusTimer && paused === false) {
        focusTimer.textContent = $('countdown').textContent;
      }
    }, 1000);
    // ==== START PULSE TIMER ====
    if (tasks[current].pulse > 0) {
      clearInterval(pulseTimer);
      pulseTimer = setInterval(() => {
        firePulse(tasks[current]);
      }, 20 * 1000);
    }
    if (tasks[current].pauseStartedAt) {
      tasks[current].pauses += Math.floor(
        (Date.now() - tasks[current].pauseStartedAt) / 1000
      );
      tasks[current].pauseStartedAt = null;
    }

  } else {
    paused = true; clearInterval(tick);
    $('stateText').textContent = 'Paused';
    tasks[current].log.push({ type: 'PAUSE', time: Date.now() });
    tasks[current].pauseStartedAt = Date.now();
    clearPulseForTransition();

  }
  render();
};

/// COMPLETE BUTTON FUNCTION ///

$('completeBtn').onclick = () => {
  completeTaskWithFocusAnimation();
};

/// END SESSION FUNCTION ///

function endSession() {
  completionInFlight = false;
  $('focusCompleteWrap')?.classList.remove('focus-complete-firing');
  clearPulseForTransition();
  clearInterval(tick); paused = true;
  sessionEndTimestamp = Date.now();
  if (!sessionStartTimestamp) sessionStartTimestamp = sessionEndTimestamp;
  const total = Math.floor((sessionEndTimestamp - sessionStartTimestamp) / 1000);
  const ratio = total > 0 ? Math.round((totalFocusedSeconds / total) * 100) : 0;
  $('resTotal').textContent = fmt(total);
  $('resFocused').textContent = fmt(totalFocusedSeconds);
  $('resPaused').textContent = fmt(Math.max(0, total - totalFocusedSeconds));
  $('resRatio').textContent = ratio + '%';
  const tbody = $('resBreakdown').querySelector('tbody');
  tbody.innerHTML = '';

  tasks.forEach((t, i) => {
    const total = t.spent + (t.pauses || 0);
    const tr = document.createElement('tr');
    tr.style.cursor = 'pointer';
    tr.innerHTML = `
     <td>${t.text}</td>
      <td>${t.mode || '-'}</td>
      <td>${fmt(t.pauses || 0)}</td>
      <td>${fmt(t.spent)}</td>
      <td>${fmt(total)}</td>
    `;
    tr.onclick = () => openTaskTimeline(i);
    tbody.appendChild(tr);
  });
  

  $('resultsOverlay').style.display = 'flex';
}

$('closeStatsBtn').onclick = () => {
  tasks = [];
  current = null;
  sessionStartTimestamp = null;
  totalFocusedSeconds = 0;
  completionInFlight = false;
  $('focusCompleteWrap')?.classList.remove('focus-complete-firing');
  $('resultsOverlay').style.display = 'none';
  render();
};

render();
</script>


</body>
</html>



